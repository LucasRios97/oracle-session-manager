<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle Session Manager - Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üóÑÔ∏è</text></svg>">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Navigation Bar -->
        <nav class="nav-bar">
            <span class="nav-title">üóÑÔ∏è Oracle Manager</span>
            <div class="nav-links">
                <a href="index.html" class="nav-link active">üè† Dashboard Principal</a>
                <a href="monitor.html" class="nav-link">üìä Monitor del Servidor</a>
                <a href="monitor-users.html" class="nav-link">üë§ Monitor por Usuario</a>
            </div>
            <div class="user-display" id="userDisplay" style="margin-left: auto; padding: 8px 16px; background: var(--bg-color); border-radius: 6px; font-weight: 500;">
                Cargando...
            </div>
        </nav>

        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>üóÑÔ∏è Oracle Session Manager</h1>
                <p class="subtitle">Monitor y Gesti√≥n de Sesiones de Base de Datos</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="refreshData()">
                    üîÑ Actualizar
                </button>
                <span class="last-update">√öltima actualizaci√≥n: <span id="lastUpdate">--:--:--</span></span>
            </div>
        </header>

        <!-- Statistics Cards -->
        <section class="statistics">
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                    <h3>Total Sesiones</h3>
                    <p class="stat-value" id="totalSessions">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                    <h3>Sesiones Activas</h3>
                    <p class="stat-value" id="activeSessions">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí§</div>
                <div class="stat-content">
                    <h3>Sesiones Inactivas</h3>
                    <p class="stat-value" id="inactiveSessions">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-content">
                    <h3>Usuarios √önicos</h3>
                    <p class="stat-value" id="uniqueUsers">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üîí</div>
                <div class="stat-content">
                    <h3>Sesiones Bloqueadas</h3>
                    <p class="stat-value" id="blockedSessions">-</p>
                </div>
            </div>
        </section>

        <!-- Filters -->
        <section class="filters">
            <div class="filter-group">
                <label for="userFilter">Filtrar por Usuario:</label>
                <select id="userFilter" onchange="filterSessions()">
                    <option value="">Todos los usuarios</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="statusFilter">Filtrar por Estado:</label>
                <select id="statusFilter" onchange="filterSessions()">
                    <option value="">Todos los estados</option>
                    <option value="ACTIVE">ACTIVE</option>
                    <option value="INACTIVE">INACTIVE</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="searchFilter">Buscar:</label>
                <input type="text" id="searchFilter" placeholder="Buscar por m√≥dulo, programa, m√°quina..." oninput="filterSessions()">
            </div>
        </section>

        <!-- Users Summary Table -->
        <section class="section">
            <h2>üìã Resumen por Usuario</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Cantidad de Sesiones</th>
                            <th>Primer Login</th>
                            <th>Tiempo M√°x. √öltima Llamada</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="userSummaryTable">
                        <tr>
                            <td colspan="5" class="loading">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Active Sessions Table -->
        <section class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">üî¥ Todas las Sesiones de Usuario</h2>
                <button class="btn btn-primary btn-small" onclick="refreshActiveSessions()">
                    üîÑ Actualizar Sesiones
                </button>
            </div>
            <div class="session-count">
                Total de sesiones: <strong id="activeSessionCount">0</strong> | 
                <span style="color: #10b981;">Activas: <strong id="activeCount">0</strong></span> | 
                <span style="color: #f59e0b;">Inactivas: <strong id="inactiveCount">0</strong></span>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Usuario SO</th>
                            <th>Estado</th>
                            <th>M√°quina</th>
                            <th>M√≥dulo</th>
                            <th>Tiempo Activo</th>
                            <th>Ver SQL</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="sessionsTable">
                        <tr>
                            <td colspan="8" class="loading">Cargando sesiones...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Paginaci√≥n -->
            <div id="paginationControls" class="pagination-controls" style="display: none;">
                <button class="btn btn-secondary btn-small" onclick="goToFirstPage()" id="firstPageBtn">‚èÆÔ∏è Primera</button>
                <button class="btn btn-secondary btn-small" onclick="previousPage()" id="prevPageBtn">‚¨ÖÔ∏è Anterior</button>
                <span class="pagination-info">
                    P√°gina <strong id="currentPage">1</strong> de <strong id="totalPages">1</strong>
                    (<span id="pageRange">1-10</span> de <strong id="totalRecords">0</strong> registros)
                </span>
                <button class="btn btn-secondary btn-small" onclick="nextPage()" id="nextPageBtn">Siguiente ‚û°Ô∏è</button>
                <button class="btn btn-secondary btn-small" onclick="goToLastPage()" id="lastPageBtn">√öltima ‚è≠Ô∏è</button>
            </div>
        </section>
    </div>

    <!-- Modal para confirmar desconexi√≥n -->
    <div id="disconnectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è Confirmar Desconexi√≥n</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>¬øEst√° seguro de que desea desconectar esta sesi√≥n?</p>
                <div class="session-details" id="sessionDetails"></div>
                <div class="warning">
                    <strong>‚ö†Ô∏è Advertencia:</strong> Esta acci√≥n desconectar√° inmediatamente la sesi√≥n y no se puede deshacer.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmDisconnect()">Desconectar Sesi√≥n</button>
            </div>
        </div>
    </div>

    <!-- Modal para mostrar SQL completo -->
    <div id="sqlModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>üìù SQL en Ejecuci√≥n</h2>
                <span class="close" onclick="closeSqlModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="sql-info">
                    <p><strong>SQL ID:</strong> <span id="sqlId"></span></p>
                    <p><strong>Usuario:</strong> <span id="sqlUser"></span></p>
                    <p><strong>M√≥dulo:</strong> <span id="sqlModule"></span></p>
                    <p><strong>Programa:</strong> <span id="sqlProgram"></span></p>
                    <p><strong>Proceso:</strong> <span id="sqlProcess"></span></p>
                </div>
                <div class="sql-container">
                    <pre id="sqlText"></pre>
                </div>
                <button class="btn btn-primary" onclick="copySql()">üìã Copiar SQL</button>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar desconexi√≥n de todas las sesiones de un usuario -->
    <div id="disconnectAllModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è Confirmar Desconexi√≥n Masiva</h2>
                <span class="close" onclick="closeDisconnectAllModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>¬øEst√° seguro de que desea desconectar <strong>TODAS</strong> las sesiones del usuario?</p>
                <div class="session-details" id="userDetailsAll"></div>
                <div class="warning warning-critical">
                    <strong>‚ö†Ô∏è ADVERTENCIA CR√çTICA:</strong> Esta acci√≥n desconectar√° <strong>TODAS</strong> las sesiones del usuario simult√°neamente. Esta operaci√≥n NO se puede deshacer y puede afectar procesos en ejecuci√≥n.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDisconnectAllModal()">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmDisconnectAll()">üîå Desconectar Todas las Sesiones</button>
            </div>
        </div>
    </div>

    <!-- Modal para cambiar contrase√±a -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîë Cambiar Contrase√±a de Usuario</h2>
                <span class="close" onclick="closeChangePasswordModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="session-details" id="changePasswordDetails"></div>
                <form id="changePasswordForm" onsubmit="return false;">
                    <div class="form-group">
                        <label for="newPassword">Nueva Contrase√±a:</label>
                        <input 
                            type="password" 
                            id="newPassword" 
                            class="form-input" 
                            placeholder="Ingrese la nueva contrase√±a"
                            minlength="6"
                            required
                        >
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirmar Contrase√±a:</label>
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            class="form-input" 
                            placeholder="Confirme la nueva contrase√±a"
                            minlength="6"
                            required
                        >
                    </div>
                    <div id="passwordError" class="error-message" style="display: none;"></div>
                </form>
                <div class="warning warning-info">
                    <strong>‚ÑπÔ∏è INFORMACI√ìN:</strong> La contrase√±a debe tener al menos 6 caracteres. Esta acci√≥n cambiar√° la contrase√±a del usuario en la base de datos Oracle.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeChangePasswordModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmChangePassword()">üîë Cambiar Contrase√±a</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Theme Toggle Button -->
    <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">
        <span id="themeIcon">üåô</span>
    </button>

    <script src="auth-common.js"></script>
    <script src="app.js"></script>
    <script>
        // Inicializar autenticaci√≥n al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            await initAuth();
        });
    </script>
</body>
</html>
