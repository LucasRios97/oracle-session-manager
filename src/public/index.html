<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle Session Manager - Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ—„ï¸</text></svg>">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Navigation Bar -->
        <nav class="nav-bar">
            <span class="nav-title">ğŸ—„ï¸ Oracle Manager</span>
            <div class="nav-links">
                <a href="index.html" class="nav-link active">ğŸ  Dashboard Principal</a>
                <a href="monitor.html" class="nav-link">ğŸ“Š Monitor del Servidor</a>
                <a href="monitor-users.html" class="nav-link">ğŸ‘¤ Monitor por Usuario</a>
            </div>
            <div class="user-display" id="userDisplay" style="margin-left: auto; padding: 8px 16px; background: var(--bg-color); border-radius: 6px; font-weight: 500;">
                Cargando...
            </div>
        </nav>

        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>ğŸ—„ï¸ Oracle Session Manager</h1>
                <p class="subtitle">Monitor y GestiÃ³n de Sesiones de Base de Datos</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-warning" onclick="openUnlockAccountModal()" style="margin-right: 10px;">
                    ğŸ”“ Desbloquear Usuario
                </button>
                <button class="btn btn-primary" onclick="refreshData()">
                    ğŸ”„ Actualizar
                </button>
                <span class="last-update">Ãšltima actualizaciÃ³n: <span id="lastUpdate">--:--:--</span></span>
            </div>
        </header>

        <!-- Statistics Cards -->
        <section class="statistics">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-content">
                    <h3>Total Sesiones</h3>
                    <p class="stat-value" id="totalSessions">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">âœ…</div>
                <div class="stat-content">
                    <h3>Sesiones Activas</h3>
                    <p class="stat-value" id="activeSessions">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ’¤</div>
                <div class="stat-content">
                    <h3>Sesiones Inactivas</h3>
                    <p class="stat-value" id="inactiveSessions">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-content">
                    <h3>Usuarios Ãšnicos</h3>
                    <p class="stat-value" id="uniqueUsers">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ”’</div>
                <div class="stat-content">
                    <h3>Sesiones Bloqueadas</h3>
                    <p class="stat-value" id="blockedSessions">-</p>
                </div>
            </div>
        </section>

        <!-- Filters -->
        <section class="filters">
            <div class="filter-group">
                <label for="userFilter">Filtrar por Usuario:</label>
                <select id="userFilter" onchange="filterSessions()">
                    <option value="">Todos los usuarios</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="statusFilter">Filtrar por Estado:</label>
                <select id="statusFilter" onchange="filterSessions()">
                    <option value="">Todos los estados</option>
                    <option value="ACTIVE">ACTIVE</option>
                    <option value="INACTIVE">INACTIVE</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="searchFilter">Buscar:</label>
                <input type="text" id="searchFilter" placeholder="Buscar por mÃ³dulo, programa, mÃ¡quina..." oninput="filterSessions()">
            </div>
        </section>

        <!-- Users Summary Table -->
        <section class="section">
            <h2>ğŸ“‹ Resumen por Usuario</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Cantidad de Sesiones</th>
                            <th>Primer Login</th>
                            <th>Tiempo MÃ¡x. Ãšltima Llamada</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="userSummaryTable">
                        <tr>
                            <td colspan="5" class="loading">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Active Sessions Table -->
        <section class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">ğŸ”´ Todas las Sesiones de Usuario</h2>
                <button class="btn btn-primary btn-small" onclick="refreshActiveSessions()">
                    ğŸ”„ Actualizar Sesiones
                </button>
            </div>
            <div class="session-count">
                Total de sesiones: <strong id="activeSessionCount">0</strong> | 
                <span style="color: #10b981;">Activas: <strong id="activeCount">0</strong></span> | 
                <span style="color: #f59e0b;">Inactivas: <strong id="inactiveCount">0</strong></span>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Usuario SO</th>
                            <th>Estado</th>
                            <th>MÃ¡quina</th>
                            <th>MÃ³dulo</th>
                            <th>Tiempo Activo</th>
                            <th>Ver SQL</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="sessionsTable">
                        <tr>
                            <td colspan="8" class="loading">Cargando sesiones...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- PaginaciÃ³n -->
            <div id="paginationControls" class="pagination-controls" style="display: none;">
                <button class="btn btn-secondary btn-small" onclick="goToFirstPage()" id="firstPageBtn">â®ï¸ Primera</button>
                <button class="btn btn-secondary btn-small" onclick="previousPage()" id="prevPageBtn">â¬…ï¸ Anterior</button>
                <span class="pagination-info">
                    PÃ¡gina <strong id="currentPage">1</strong> de <strong id="totalPages">1</strong>
                    (<span id="pageRange">1-10</span> de <strong id="totalRecords">0</strong> registros)
                </span>
                <button class="btn btn-secondary btn-small" onclick="nextPage()" id="nextPageBtn">Siguiente â¡ï¸</button>
                <button class="btn btn-secondary btn-small" onclick="goToLastPage()" id="lastPageBtn">Ãšltima â­ï¸</button>
            </div>
        </section>
    </div>

    <!-- Modal para confirmar desconexiÃ³n -->
    <div id="disconnectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš ï¸ Confirmar DesconexiÃ³n</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Â¿EstÃ¡ seguro de que desea desconectar esta sesiÃ³n?</p>
                <div class="session-details" id="sessionDetails"></div>
                <div class="warning">
                    <strong>âš ï¸ Advertencia:</strong> Esta acciÃ³n desconectarÃ¡ inmediatamente la sesiÃ³n y no se puede deshacer.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmDisconnect()">Desconectar SesiÃ³n</button>
            </div>
        </div>
    </div>

    <!-- Modal para mostrar SQL completo -->
    <div id="sqlModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>ğŸ“ SQL en EjecuciÃ³n</h2>
                <span class="close" onclick="closeSqlModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="sql-info">
                    <p><strong>SQL ID:</strong> <span id="sqlId"></span></p>
                    <p><strong>Usuario:</strong> <span id="sqlUser"></span></p>
                    <p><strong>MÃ³dulo:</strong> <span id="sqlModule"></span></p>
                    <p><strong>Programa:</strong> <span id="sqlProgram"></span></p>
                    <p><strong>Proceso:</strong> <span id="sqlProcess"></span></p>
                </div>
                <div class="sql-container">
                    <pre id="sqlText"></pre>
                </div>
                <button class="btn btn-primary" onclick="copySql()">ğŸ“‹ Copiar SQL</button>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar desconexiÃ³n de todas las sesiones de un usuario -->
    <div id="disconnectAllModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš ï¸ Confirmar DesconexiÃ³n Masiva</h2>
                <span class="close" onclick="closeDisconnectAllModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Â¿EstÃ¡ seguro de que desea desconectar <strong>TODAS</strong> las sesiones del usuario?</p>
                <div class="session-details" id="userDetailsAll"></div>
                <div class="warning warning-critical">
                    <strong>âš ï¸ ADVERTENCIA CRÃTICA:</strong> Esta acciÃ³n desconectarÃ¡ <strong>TODAS</strong> las sesiones del usuario simultÃ¡neamente. Esta operaciÃ³n NO se puede deshacer y puede afectar procesos en ejecuciÃ³n.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDisconnectAllModal()">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmDisconnectAll()">ğŸ”Œ Desconectar Todas las Sesiones</button>
            </div>
        </div>
    </div>

    <!-- Modal para cambiar contraseÃ±a -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ”‘ Cambiar ContraseÃ±a de Usuario</h2>
                <span class="close" onclick="closeChangePasswordModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="session-details" id="changePasswordDetails"></div>
                <form id="changePasswordForm" onsubmit="return false;">
                    <div class="form-group">
                        <label for="newPassword">Nueva ContraseÃ±a:</label>
                        <input 
                            type="password" 
                            id="newPassword" 
                            class="form-input" 
                            placeholder="Ingrese la nueva contraseÃ±a"
                            minlength="6"
                            required
                        >
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirmar ContraseÃ±a:</label>
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            class="form-input" 
                            placeholder="Confirme la nueva contraseÃ±a"
                            minlength="6"
                            required
                        >
                    </div>
                    <div id="passwordError" class="error-message" style="display: none;"></div>
                </form>
                <div class="warning warning-info">
                    <strong>â„¹ï¸ INFORMACIÃ“N:</strong> La contraseÃ±a debe tener al menos 6 caracteres. Esta acciÃ³n cambiarÃ¡ la contraseÃ±a del usuario en la base de datos Oracle.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeChangePasswordModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmChangePassword()">ğŸ”‘ Cambiar ContraseÃ±a</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Theme Toggle Button -->
    <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">
        <span id="themeIcon">ğŸŒ™</span>
    </button>

    <!-- BotÃ³n flotante para cambiar contraseÃ±a -->
    <button id="quickPasswordBtn" class="quick-action-btn" onclick="openQuickPasswordModal()" title="Cambiar ContraseÃ±a de Usuario">
        ğŸ”‘
    </button>

    <!-- BotÃ³n flotante para ver sesiones bloqueantes -->
    <button id="blockingSessionsBtn" class="quick-action-btn-2" onclick="openBlockingSessionsModal()" title="Ver Sesiones Bloqueantes">
        ğŸ”’
    </button>

    <!-- Modal rÃ¡pido para cambiar contraseÃ±a -->
    <div id="quickPasswordModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>ğŸ”‘ Cambiar ContraseÃ±a de Usuario</h2>
                <span class="close" onclick="closeQuickPasswordModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="quickPasswordForm" onsubmit="return false;">
                    <div class="form-group">
                        <label for="quickUsername">Usuario:</label>
                        <input 
                            type="text" 
                            id="quickUsername" 
                            class="form-input" 
                            placeholder="Nombre de usuario Oracle"
                            required
                            autocomplete="off"
                        >
                    </div>
                    <div class="form-group">
                        <label for="quickNewPassword">Nueva ContraseÃ±a:</label>
                        <input 
                            type="password" 
                            id="quickNewPassword" 
                            class="form-input" 
                            placeholder="Nueva contraseÃ±a (mÃ­nimo 6 caracteres)"
                            minlength="6"
                            required
                        >
                    </div>
                    <div class="form-group">
                        <label for="quickConfirmPassword">Confirmar ContraseÃ±a:</label>
                        <input 
                            type="password" 
                            id="quickConfirmPassword" 
                            class="form-input" 
                            placeholder="Confirme la contraseÃ±a"
                            minlength="6"
                            required
                        >
                    </div>
                    <div id="quickPasswordError" class="error-message" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeQuickPasswordModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmQuickPasswordChange()">ğŸ”‘ Cambiar ContraseÃ±a</button>
            </div>
        </div>
    </div>

    <!-- Modal de Sesiones Bloqueantes -->
    <div id="blockingSessionsModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>ğŸ”’ Sesiones Bloqueando Objetos</h2>
                <span class="close" onclick="closeBlockingSessionsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="blockingSessionsContent">
                    <p class="loading">Cargando sesiones bloqueantes...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="refreshBlockingSessions()">ğŸ”„ Actualizar</button>
                <button class="btn btn-secondary" onclick="closeBlockingSessionsModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Desbloquear Usuario -->
    <div id="unlockAccountModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>ğŸ”“ Desbloquear Cuenta de Usuario</h2>
                <span class="close" onclick="closeUnlockAccountModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Ingrese el nombre del usuario cuya cuenta desea desbloquear:</p>
                <form id="unlockAccountForm" onsubmit="return false;">
                    <div class="form-group">
                        <label for="unlockUsername">Usuario:</label>
                        <input 
                            type="text" 
                            id="unlockUsername" 
                            class="form-input" 
                            placeholder="Nombre de usuario Oracle"
                            required
                            autocomplete="off"
                        >
                    </div>
                    <div id="unlockError" class="error-message" style="display: none;"></div>
                </form>
                <div class="warning warning-info">
                    <strong>â„¹ï¸ INFORMACIÃ“N:</strong> Esta acciÃ³n desbloquearÃ¡ la cuenta del usuario en la base de datos Oracle.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUnlockAccountModal()">Cancelar</button>
                <button class="btn btn-warning" onclick="confirmUnlockAccount()">ğŸ”“ Desbloquear</button>
            </div>
        </div>
    </div>

    <script src="auth-common.js"></script>
    <script src="app.js"></script>
    <script>
        // Inicializar autenticaciÃ³n al cargar la pÃ¡gina
        document.addEventListener('DOMContentLoaded', async () => {
            await initAuth();
        });
    </script>
</body>
</html>
